<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart - E-Commerce Store</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-logo">üõí ShopEasy</h1>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="products.html">Products</a>
                <a href="cart.html" class="active">Cart <span id="cart-count">0</span></a>
                <a href="orders.html">Orders</a>
                <a href="admin.html" id="admin-link" style="display:none;">Admin</a>
                <a href="#" id="auth-link">Login</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>Shopping Cart</h2>
            <div class="cart-actions">
                <button onclick="undoLastAction()" id="undo-btn" disabled>‚Ü©Ô∏è Undo Last Action</button>
                <button onclick="clearCart()" id="clear-cart-btn">üóëÔ∏è Clear Cart</button>
            </div>
        </div>
        
        <div id="cart-items">
            <!-- Cart items will be loaded here -->
        </div>
        
        <div class="cart-summary">
            <h3>Total: Ksh<span id="cart-total">0.00</span></h3>
            <button onclick="checkout()" id="checkout-btn" disabled>Proceed to Checkout</button>
        </div>

        <!-- Stack Info -->
        <div class="data-structures-info">
            <h3>Undo Stack Information</h3>
            <div class="ds-cards">
                <div class="ds-card">
                    <h4>üîÑ Action Stack</h4>
                    <p>Track your recent cart actions</p>
                    <div id="stack-details">
                        <div>Actions in stack: <span id="stack-size">0</span></div>
                        <div>Last action: <span id="last-action">None</span></div>
                        <div>Can undo: <span id="can-undo">No</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let currentUser = null;
        let cart = [];

        // Check authentication and load user info
        function checkAuth() {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');
            
            if (token && userData) {
                currentUser = JSON.parse(userData);
                updateNavigation();
                loadCart();
                loadUndoInfo();
            } else {
                window.location.href = 'login.html';
            }
        }

        function updateNavigation() {
            const authLink = document.getElementById('auth-link');
            const adminLink = document.getElementById('admin-link');
            
            if (currentUser) {
                authLink.textContent = 'Logout';
                authLink.href = '#';
                authLink.onclick = logout;
                
                if (currentUser.role === 'admin') {
                    adminLink.style.display = 'block';
                }
            } else {
                authLink.textContent = 'Login';
                authLink.href = 'login.html';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Cart functions
        async function loadCart() {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            try {
                const response = await fetch(`${API_BASE}/cart`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    cart = await response.json();
                    displayCart();
                    updateCartCount();
                }
            } catch (error) {
                console.error('Failed to load cart:', error);
            }
        }

        function displayCart() {
            const container = document.getElementById('cart-items');
            const totalElement = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');
            
            if (!cart || cart.length === 0) {
                container.innerHTML = '<p>Your cart is empty.</p>';
                totalElement.textContent = '0.00';
                checkoutBtn.disabled = true;
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            container.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <h4>${item.name}</h4>
                        <p>$${item.price} each</p>
                    </div>
                    <div class="cart-item-actions">
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="updateCartItem(${item.cart_id}, ${item.quantity - 1})">-</button>
                            <span>${item.quantity}</span>
                            <button class="quantity-btn" onclick="updateCartItem(${item.cart_id}, ${item.quantity + 1})">+</button>
                        </div>
                        <div>$${(item.price * item.quantity).toFixed(2)}</div>
                        <button class="btn btn-danger" onclick="removeFromCart(${item.cart_id})">Remove</button>
                    </div>
                </div>
            `).join('');
            
            totalElement.textContent = total.toFixed(2);
            checkoutBtn.disabled = false;
        }

        async function updateCartItem(cartId, quantity) {
            if (quantity < 1) {
                removeFromCart(cartId);
                return;
            }
            
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_BASE}/cart/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ cart_id: cartId, quantity })
                });
                
                if (response.ok) {
                    loadCart();
                    loadUndoInfo();
                }
            } catch (error) {
                console.error('Failed to update cart:', error);
            }
        }

        async function removeFromCart(cartId) {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_BASE}/cart/remove/${cartId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    loadCart();
                    loadUndoInfo();
                }
            } catch (error) {
                console.error('Failed to remove from cart:', error);
            }
        }

        async function clearCart() {
            if (!confirm('Are you sure you want to clear your cart?')) return;
            
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_BASE}/cart/clear`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    loadCart();
                    loadUndoInfo();
                alert('Cart cleared successfully!');
                }
            } catch (error) {
                console.error('Failed to clear cart:', error);
            }
        }

        function updateCartCount() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = count;
        }

        // Undo functionality
        async function loadUndoInfo() {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            try {
                const response = await fetch(`${API_BASE}/cart/undo-info`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const info = await response.json();
                    const undoBtn = document.getElementById('undo-btn');
                    undoBtn.disabled = !info.can_undo;
                    
                    document.getElementById('stack-size').textContent = info.size;
                    document.getElementById('last-action').textContent = info.last_action || 'None';
                    document.getElementById('can-undo').textContent = info.can_undo ? 'Yes' : 'No';
                    
                    if (info.can_undo) {
                        undoBtn.title = `Undo: ${info.last_action}`;
                    }
                }
            } catch (error) {
                console.error('Failed to load undo info:', error);
            }
        }

        async function undoLastAction() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_BASE}/cart/undo`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    loadCart();
                    loadUndoInfo();
                    alert(`Undid ${result.undone_action}`);
                }
            } catch (error) {
                console.error('Failed to undo:', error);
            }
        }

        function checkout() {
            window.location.href = 'checkout.html';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });
    </script>
</body>
</html>